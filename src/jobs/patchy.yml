description: |
  Automated patching.

  The following Make targets are required and will be called:
   - init-backend
   - mkdirs

parameters:
  executor:
    type: executor
    description: The executor to use.
  ssh_fingerprint:
    description: The SSH fingerprint used for writing back to the project repo.
    type: string
  cache-version:
    description: An optional version number for cache dependencies, e.g. v1
    type: string
    default: v1
  post-patch:
    type: steps
    description: Provide any optional post-test steps you would like to run.
    default: []
  composer_lock_diff_path:
    type: string
    description: The path to the composer-lock-diff binary.
    default: ./bin/composer-lock-diff
  config_export_dir:
    type: string
    description: The directory to which Drupal configuration is exported.
    default: config-export
executor: <<parameters.executor>>

steps:
  - add_ssh_keys:
      fingerprints:
        - <<parameters.ssh_fingerprint>>
  - checkout
  - restore_cache:
      keys:
        - deps-composer-<<parameters.cache-version>>-{{ arch }}-{{ checksum "composer.lock" }}
  - run:
      name: Set environment variables
      command: |
        echo 'export DRUPAL_CONFIG_EXPORT_DIR="<< parameters.config_export_dir >>"' >> "$BASH_ENV"
        echo 'export COMPOSER_LOCK_DIFF_PATH="<< parameters.config_export_dir >>"' >> "$BASH_ENV"
  - run:
      name: Init
      command: make init-backend mkdirs
  - run:
      name: Patchy
      command: <<include(scripts/patchy.sh)>>
  - steps: <<parameters.post-patch>>
